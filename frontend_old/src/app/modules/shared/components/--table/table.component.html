<div class="table-container">
  <table class="table">
    <thead>
      <tr>
        <!-- ✅ REFACTOR: Columna para el checkbox de selección de cabecera -->
        @if (selection) {
          <th class="selection-cell">
            <app-toggle-checkbox
              [state]="headerCheckboxState"
              (click)="onToggleAll()"
              aria-label="Seleccionar todo">
            </app-toggle-checkbox>
          </th>
        }
        @for (col of columns; track col.key) {
          <th 
            [style.width]="col.width" 
            [style.min-width]="col.minWidth"
            [class.sortable]="col.sortable"
            (click)="onSort(col.key, col.sortable)">
            {{ col.label }}
            @if (col.sortable) {
              <app-ui-icon 
                class="sort-icon"
                [name]="sortKey === col.key ? (sortOrder === 'asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'" />
            }
          </th>
        }
        <!-- Cabecera para la columna de acciones -->
        <th class="actions-cell"></th>
      </tr>
    </thead>
    <tbody>
      @for (item of items; track item.id) {
        <tr (click)="onRowClick(item, $event)" [class.selected]="selection?.has(item.id)">
          <!-- ✅ REFACTOR: Celda para el checkbox de selección de fila -->
          @if (selection) {
            <td class="selection-cell" (click)="$event.stopPropagation()">
              <app-toggle-checkbox [state]="selection.has(item.id) ? 'on' : 'off'"></app-toggle-checkbox>
            </td>
          }
          @for (col of columns; track col.key) {
            <td>
              @switch (col.type) {
                @case ('flag') {
                  <app-flag-icon [name]="getCellValue(item, col.key)"></app-flag-icon>
                }
                @default {
                  {{ getCellValue(item, col.key) }}
                }
              }
            </td>
          }
          <td class="actions-cell" (click)="$event.stopPropagation()">
            <app-ui-button (click)="onAction('edit', item)" variant="icon" icon="pencil" aria-label="Editar"></app-ui-button>
            <app-ui-button (click)="onAction('delete', item)" variant="icon" icon="trash" color="danger" aria-label="Eliminar"></app-ui-button>
          </td>
        </tr>
      } @empty {
        <tr><td [attr.colspan]="columns.length + (selection ? 2 : 1)" class="no-data-cell">No hay datos para mostrar.</td></tr>
      }
    </tbody>
  </table>
</div>